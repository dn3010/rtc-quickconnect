!function(a){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=a();else if("function"==typeof define&&define.amd)define([],a);else{var b;b="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,b.quickconnect=a()}}(function(){var a;return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){(function(c){"use strict";var d=a("rtc-tools"),e=a("mbus"),f=a("rtc-core/plugin"),g=d.logger("rtc-quickconnect"),h=a("cog/extend");b.exports=function(b,i){function j(){clearTimeout(M),C||A&&(K&&!t||L&&E.length<L||(M=setTimeout(function(){var a=h({room:y},B);b.announce(a),C=!0},0)))}function k(a,c){function f(b){g("connection for "+a+" is no longer pending ["+(b||"no reason")+"], connect available again"),H[a]&&delete H[a],I[a]&&delete I[a]}if(g("connecting to "+a),!a)return g("invalid target peer ID");if(H[a])return g("a connection is already pending for "+a+", as of "+(Date.now()-H[a])+"ms ago");c=c||{};var j,k,l,n=D.get(c.scheme,!0),o=v(a);return o.room!==y?g("mismatching room, expected: "+y+", got: "+(o&&o.room)):o.id!==a?g("mismatching ids, expected: "+a+", got: "+o.id):(H[a]=Date.now(),F.end(a),b("peer:prepare",a,o,n),void w(h({targetPeer:a},i,(n||{}).connection),function(c,p){c?b("icegeneration:error",a,n&&n.id,c):b("peer:iceservers",a,n&&n.id,p||[]),j=d.createConnection(h({},i,{iceServers:p}),(i||{}).constraints),b("peer:connect",a,j,o),l=F.create(a,j,o),E.forEach(function(a){j.addStream(a)}),b.isMaster(a)?(g("is master, creating data channels: ",Object.keys(G)),Object.keys(G).forEach(function(a){m(j.createDataChannel(a,G[a]),j,o)})):j.ondatachannel=function(b){var c=b&&b.channel;c&&void 0!==G[c.label]&&m(c,j,v(a))},g("coupling "+b.id+" to "+a),k=d.couple(j,a,b,h({},i,{logger:e("pc."+a,b)})),l.monitor=k,k.once("connected",function(){f("connected successfully"),F.start(a,j,o)}),k.once("closed",function(){f("closed"),F.end(a)}),k.once("aborted",function(){f("aborted")}),k.once("failed",function(){f("failed"),F.fail(a)}),k.once("failing",F.failing.bind(null,a)),k.once("recovered",F.recovered.bind(null,a)),b("peer:couple",a,j,o,k),b.isMaster(a)&&k.createOffer(),b("peer:prepared",a)}))}function l(a){var b=F.get(a);if(!b)throw new Error("No active call for peer: "+a);return b}function m(a,c,d){function e(){var e=F.get(d.id),f=[d.id,a,d,c];g('reporting channel "'+a.label+'" ready, have call: '+!!e),clearInterval(h),clearTimeout(j),a.onopen=null,e&&e.channels.set(a.label,a),g("triggering channel:opened events for channel: "+a.label),b.apply(b,["channel:opened"].concat(f)),b.apply(b,["channel:opened:"+a.label].concat(f))}function f(){g("recreating data channel: "+a.label),clearInterval(h),clearTimeout(j),["connecting","open"].indexOf(a.readyState)!==-1&&a.close(),b.createDataChannel(a.label,G[a.label])}var h,j;return g("channel "+a.label+" discovered for peer: "+d.id),"open"===a.readyState?e():(g("channel not ready, current state = "+a.readyState),a.onopen=e,void(h=setInterval(function(){g("checking channel state, current state = "+a.readyState+", connection state "+c.iceConnectionState),"open"===a.readyState?e():["failed","closed"].indexOf(c.iceConnectionState)!==-1?(g("connection has terminated, cancelling channel monitor"),clearInterval(h),clearTimeout(j)):"connected"!==c.iceConnectionState||"connecting"!==a.readyState||j||(j=setTimeout(function(){if("connecting"===a.readyState){var e=[d.id,a,d,c];return b.apply(b,["channel:failed"].concat(e)),b.apply(b,["channel:failed:"+a.label].concat(e)),f()}},(i||{}).channelTimeout||2e3))},500)))}function n(){return K&&K.init(i,function(a){return a?console.error("Could not initialize plugin: ",a):(t=!0,void j())})}function o(a){a&&"undefined"!=typeof a.room&&(y=a.room)}function p(a,b){b.allow=b.allow&&E.length>=L}function q(a){if(C){var c=a&&a.id,d=c&&F.get(c);return!c||d||H[c]||I[c]?void 0:(g("received peer update from peer "+c+", no active calls"),b("peer:autoreconnect",c),b.reconnectTo(c))}}function r(a){var b=a&&a.id;b&&(delete H[b],F.end(b))}function s(a){if(C)return delete H[a],g("call has from "+b.id+" to "+a+" has ended, reannouncing"),b.profile()}var t,u="undefined"!=typeof location&&location.hash.slice(1),v=a("./lib/getpeerdata")(b.peers),w=a("rtc-core/genice"),x=(i||{}).ns||"",y=(i||{}).room,z=(i||{}).debug,A=!(i||{}).manualJoin,B={},C=!1,D=a("./lib/schemes")(b,i),E=[],F=b.calls=a("./lib/calls")(b,i),G={},H={},I={},J=b.plugins=(i||{}).plugins||[],K=f(J),L=parseInt((i||{}).expectedLocalStreams,10)||0,M=0,N=0;return y||("undefined"==typeof location||u||(u=location.hash=""+Math.pow(2,53)*Math.random()),y=x+"#"+u),z&&d.logger.enable.apply(d.logger,Array.isArray(g)?z:["*"]),b.on("peer:announce",function(a){k(a.id,{scheme:a.scheme})}),b.on("peer:update",q),b.on("message:reconnect",function(a,c,d){if(g("received reconnect message"),d||(d=c,c=a,a=void 0),!c.id)return console.warn("Could not reconnect, no sender ID");F.abort(c.id),delete I[c.id],b("peer:reconnecting",c.id,a||{}),k(c.id,a||{});var e=b.isMaster(c.id);e&&b.to(c.id).send("/reconnect",a||{})}),b.broadcast=b.addStream=function(a){return E.push(a),F.values().forEach(function(b){b.pc.addStream(a)}),j(),b},b.endCall=F.end,b.endCalls=function(){F.keys().forEach(F.end)},b.close=function(){C=!1,N&&clearTimeout(N),b.endCalls(),b.leave()},b.createDataChannel=function(a,c){return F.keys().forEach(function(d){var e,f=F.get(d);f&&f.pc&&b.isMaster(d)&&(e=f.pc.createDataChannel(a,c),m(e,f.pc,v(d)))}),G[a]=c||null,b},b.join=function(){A=!0,j()},b.get=function(a){return B[a]},b.getLocalStreams=function(){return[].concat(E)},b.reactive=function(){return i=i||{},i.reactive=!0,b},b.registerScheme=D.add,b.getScheme=D.get,b.removeStream=function(a){var c=E.indexOf(a);return F.values().forEach(function(b){if(b.pc.removeTrack)a.getTracks().forEach(function(a){try{b.pc.removeTrack(a)}catch(c){console.error("Error removing media track",c)}});else try{b.pc.removeStream(a)}catch(c){console.error("Failed to remove media stream",c)}}),c>=0&&E.splice(c,1),b},b.requestChannel=function(a,c,d){var e=l(a),f=e&&e.channels.get(c);return f?(d(null,f),b):(b.once("channel:opened:"+c,function(a,b){d(null,b)}),b)},b.requestStream=function(a,c,d){function e(h){h===a&&(f=g.pc.getRemoteStreams()[c],f&&(b.removeListener("stream:added",e),d(null,f)))}var f,g=l(a);return(f=g.pc.getRemoteStreams()[c])?(d(null,f),b):(b.on("stream:added",e),b)},b.profile=function(a){return h(B,a||{}),C&&(clearTimeout(N),N=setTimeout(function(){C&&(g("["+b.id+"] reannouncing"),b.announce(B))},(i||{}).updateDelay||1e3)),b},b.waitForCall=function(a,c){var d=F.get(a);return d&&d.active?(c(null,d.pc),b):void b.on("call:started",function d(e){e===a&&(b.removeListener("call:started",d),c(null,F.get(e).pc))})},b.reconnectTo=function(a,c){if(a){b.to(a).send("/reconnect",c);var d=b.isMaster(a);if(d){b("log","aborting call");try{F.abort(a)}catch(e){b("log",e.message)}return b("log","call aborted"),b("peer:reconnecting",a,c||{}),k(a,c)}I[a]=Date.now()}},L&&b.on("peer:filter",p),b.on("local:announce",o),b.on("message:ping",F.ping),b.on("message:leave",r),b.on("call:ended",s),K?n():c.nextTick(function(){j()}),b}}).call(this,a("_process"))},{"./lib/calls":2,"./lib/getpeerdata":3,"./lib/schemes":5,_process:16,"cog/extend":7,mbus:14,"rtc-core/genice":19,"rtc-core/plugin":20,"rtc-tools":29}],2:[function(a,b,c){(function(c){var d=a("rtc-tools"),e=d.logger("rtc-quickconnect"),f=a("rtc-tools/cleanup"),g=a("cog/getable");b.exports=function(b,d){function h(a,c,d){var f=v.create(a),h={active:!1,signalling:!1,pc:c,channels:g({}),streams:[],lastping:Date.now(),heartbeat:f};return t.set(a,h),f.on("signalling:state",function(a){h.signalling=a}),e(w+"call has been created for "+a+" (not yet started)"),b("call:created",a,c,d),h}function i(a){return function(b){e(w+"peer "+a+" added stream"),s(a),q(a)(b.stream)}}function j(a){return function(c){e(w+"peer "+a+" removed stream"),s(a),b("stream:removed",a,c.stream)}}function k(a){var c=t.get(a);c&&(e(w+"call is failing for "+a),b("call:failing",a,c&&c.pc))}function l(a){var c=t.get(a);c&&(e(w+"call has recovered for "+a),b("call:recovered",a,c&&c.pc))}function m(a){var c=t.get(a);c&&(e(w+"call has failed for "+a),b("call:failed",a,c&&c.pc),o(a))}function n(a){var c=t.get(a);c&&(c.monitor&&c.monitor.abort(),b("call:aborted",a,c&&c.pc),o(a))}function o(a){var c=t.get(a);c&&(c.heartbeat&&c.heartbeat.stop(),c.monitor&&c.monitor.stop(),c.channels.keys().forEach(function(d){var e=c.channels.get(d),f=[a,e,d];b.apply(b,["channel:closed"].concat(f)),b.apply(b,["channel:closed:"+d].concat(f)),e.onopen=null}),c.streams.forEach(function(c){b("stream:removed",a,c)}),t.delete(a),e(w+"call has ended for "+a),b("call:ended",a,c.pc),b("call:"+a+":ended",c.pc),f(c.pc))}function p(a){var b=t.get(a&&a.id);b&&(b.lastping=Date.now(),b.heartbeat.touch())}function q(a){return function(c){b("stream:added",a,c,u(a))}}function r(a,d,f){var g=t.get(a),h=[].concat(d.getRemoteStreams());g.active=!0,g.streams=[].concat(d.getRemoteStreams()),d.onaddstream=i(a),d.onremovestream=j(a),e(w+" -> "+a+" call start: "+h.length+" streams"),b("call:started",a,d,f),g.lastping=Date.now(),g.heartbeat.once("disconnected",function(){return b("call:expired",a,g.pc),o(a)}),c.nextTick(function(){h.forEach(q(a))})}function s(a){var b=t.get(a);b&&b.pc&&(b.streams=[].concat(b.pc.getRemoteStreams()))}var t=g({}),u=a("./getpeerdata")(b.peers),v=a("./heartbeat")(b,d),w="["+b.id+"] ";return t.abort=n,t.create=h,t.end=o,t.fail=m,t.failing=k,t.ping=p,t.start=r,t.recovered=l,t}}).call(this,a("_process"))},{"./getpeerdata":3,"./heartbeat":4,_process:16,"cog/getable":8,"rtc-tools":29,"rtc-tools/cleanup":25}],3:[function(a,b,c){b.exports=function(a){return function(b){var c=a.get(b);return c&&c.data}}},{}],4:[function(a,b,c){var d=a("mbus");b.exports=function(a,b){function c(c){function e(){a.to(c).send("/ping")}function f(){var a=Date.now()-4*i,b=j?j:m>=a;l!==b&&(h(b?"connected":"disconnected"),h("signalling:state",b),l=b)}function g(){f(),e()}var h=d(),i="number"==typeof b.heartbeat?b.heartbeat:2500,j=(b||{}).ignoreDisconnection||!1,k=null,l=!1,m=0;return h.start=function(){k&&h.stop(),i<=0||(k=setInterval(g,i),g())},h.stop=function(){k&&(clearInterval(k),k=null)},h.touch=function(){m=Date.now(),f()},h.updateDelay=function(a){i=a,h.start()},h.start(),h}return b=b||{},{create:c}}},{mbus:14}],5:[function(a,b,c){var d=a("rtc-tools");d.logger("rtc-quickconnect");b.exports=function(a,b){function c(a){if(!a||!a.id||"string"!=typeof a.id)throw new Error("Cannot add invalid scheme. Requires at least an ID");if(f[a.id])throw new Error("Scheme "+schemeId+" already exists");a.isDefault&&(e?console.warn("Default scheme already exists"):e=a.id),f[a.id]=a}function d(a,b){return f[a]||(b&&e?f[e]:void 0)}var e,f={};return b&&b.schemes&&Array.isArray(b.schemes)&&b.schemes.forEach(c),{add:c,get:d}}},{"rtc-tools":29}],6:[function(a,b,c){"use strict";b.exports=function(a){return a=a||{},[].slice.call(arguments,1).forEach(function(b){if(b)for(var c in b)void 0===a[c]&&(a[c]=b[c])}),a}},{}],7:[function(a,b,c){"use strict";b.exports=function(a){return[].slice.call(arguments,1).forEach(function(b){if(b)for(var c in b)a[c]=b[c]}),a}},{}],8:[function(a,b,c){b.exports=function(a){function b(b){return a[b]}function c(b,c){a[b]=c}function d(b){return delete a[b]}function e(){return Object.keys(a)}function f(){return Object.keys(a).map(function(b){return a[b]})}return"object"!=typeof a?a:{get:b,set:c,remove:d,delete:d,keys:e,values:f}}},{}],9:[function(a,b,c){"use strict";var d=[],e=[],f=[console],g=b.exports=function(a){function b(){return c=d.indexOf("*")>=0||d.indexOf(a)>=0}var c=b();return e[e.length]=b,function(){var b=[].slice.call(arguments);("string"==typeof b[0]||b[0]instanceof String)&&(b[0]=a+": "+b[0]),c&&f.forEach(function(a){a.log.apply(a,b)})}};g.reset=function(){return f=[],d=[],g.enable()},g.to=function(a){return f=f.concat(a||[]),g},g.enable=function(){return d=d.concat([].slice.call(arguments)),e.forEach(function(a){a()}),g}},{}],10:[function(a,b,c){"use strict";b.exports=function(a,b,c){function d(){a.apply(g,f||[]),h=Date.now()}var e,f,g,h=(c||{}).leading!==!1?0:Date.now(),i=(c||{}).trailing;return i=i||void 0===i,function(){var c=Date.now(),j=c-h;return clearTimeout(e),j<b?(f=[].slice.call(arguments,0),g=this,i&&(e=setTimeout(d,b-j))):(h=c,void a.apply(this,arguments))}}},{}],11:[function(a,b,c){var d=a("./lib/detectBrowser");b.exports=d(navigator.userAgent)},{"./lib/detectBrowser":12}],12:[function(a,b,c){b.exports=function(a){function b(b){return b.concat(b[1].exec(a))}function c(a){return!!a[2]}var d=[["edge",/Edge\/([0-9\._]+)/],["chrome",/(?!Chrom.*OPR)Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["crios",/CriOS\/([0-9\.]+)(:?\s|$)/],["firefox",/Firefox\/([0-9\.]+)(?:\s|$)/],["opera",/Opera\/([0-9\.]+)(?:\s|$)/],["opera",/OPR\/([0-9\.]+)(:?\s|$)$/],["ie",/Trident\/7\.0.*rv\:([0-9\.]+)\).*Gecko$/],["ie",/MSIE\s([0-9\.]+);.*Trident\/[4-7].0/],["ie",/MSIE\s(7\.0)/],["bb10",/BB10;\sTouch.*Version\/([0-9\.]+)/],["android",/Android\s([0-9\.]+)/],["ios",/iPad.*Version\/([0-9\._]+)/],["ios",/iPhone.*Version\/([0-9\._]+)/],["safari",/Version\/([0-9\._]+).*Safari/]],e=0,f=[];for(e=0;e<d.length;e++)d[e]=b(d[e]),c(d[e])&&f.push(d[e]);for(var g=f[0],h=g&&g[3].split(/[._]/).slice(0,3);h&&h.length<3;)h.push("0");return{name:g&&g[0],version:h&&h.join(".")}}},{}],13:[function(b,c,d){(function(e,f){!function(b,e){"object"==typeof d&&"undefined"!=typeof c?c.exports=e():"function"==typeof a&&a.amd?a(e):b.ES6Promise=e()}(this,function(){"use strict";function a(a){return"function"==typeof a||"object"==typeof a&&null!==a}function c(a){return"function"==typeof a}function d(a){X=a}function g(a){Y=a}function h(){return function(){return e.nextTick(m)}}function i(){return function(){W(m)}}function j(){var a=0,b=new _(m),c=document.createTextNode("");return b.observe(c,{characterData:!0}),function(){c.data=a=++a%2}}function k(){var a=new MessageChannel;return a.port1.onmessage=m,function(){return a.port2.postMessage(0)}}function l(){var a=setTimeout;return function(){return a(m,1)}}function m(){for(var a=0;a<V;a+=2){var b=ca[a],c=ca[a+1];b(c),ca[a]=void 0,ca[a+1]=void 0}V=0}function n(){try{var a=b,c=a("vertx");return W=c.runOnLoop||c.runOnContext,i()}catch(d){return l()}}function o(a,b){var c=arguments,d=this,e=new this.constructor(q);void 0===e[ea]&&J(e);var f=d._state;return f?!function(){var a=c[f-1];Y(function(){return G(f,e,a,d._result)})}():C(d,e,a,b),e}function p(a){var b=this;if(a&&"object"==typeof a&&a.constructor===b)return a;var c=new b(q);return y(c,a),c}function q(){}function r(){return new TypeError("You cannot resolve a promise with itself")}function s(){return new TypeError("A promises callback cannot return that same promise.")}function t(a){try{return a.then}catch(b){return ia.error=b,ia}}function u(a,b,c,d){try{a.call(b,c,d)}catch(e){return e}}function v(a,b,c){Y(function(a){var d=!1,e=u(c,b,function(c){d||(d=!0,b!==c?y(a,c):A(a,c))},function(b){d||(d=!0,B(a,b))},"Settle: "+(a._label||" unknown promise"));!d&&e&&(d=!0,B(a,e))},a)}function w(a,b){b._state===ga?A(a,b._result):b._state===ha?B(a,b._result):C(b,void 0,function(b){return y(a,b)},function(b){return B(a,b)})}function x(a,b,d){b.constructor===a.constructor&&d===o&&b.constructor.resolve===p?w(a,b):d===ia?B(a,ia.error):void 0===d?A(a,b):c(d)?v(a,b,d):A(a,b)}function y(b,c){b===c?B(b,r()):a(c)?x(b,c,t(c)):A(b,c)}function z(a){a._onerror&&a._onerror(a._result),D(a)}function A(a,b){a._state===fa&&(a._result=b,a._state=ga,0!==a._subscribers.length&&Y(D,a))}function B(a,b){a._state===fa&&(a._state=ha,a._result=b,Y(z,a))}function C(a,b,c,d){var e=a._subscribers,f=e.length;a._onerror=null,e[f]=b,e[f+ga]=c,e[f+ha]=d,0===f&&a._state&&Y(D,a)}function D(a){var b=a._subscribers,c=a._state;if(0!==b.length){for(var d=void 0,e=void 0,f=a._result,g=0;g<b.length;g+=3)d=b[g],e=b[g+c],d?G(c,d,e,f):e(f);a._subscribers.length=0}}function E(){this.error=null}function F(a,b){try{return a(b)}catch(c){return ja.error=c,ja}}function G(a,b,d,e){var f=c(d),g=void 0,h=void 0,i=void 0,j=void 0;if(f){if(g=F(d,e),g===ja?(j=!0,h=g.error,g=null):i=!0,b===g)return void B(b,s())}else g=e,i=!0;b._state!==fa||(f&&i?y(b,g):j?B(b,h):a===ga?A(b,g):a===ha&&B(b,g))}function H(a,b){try{b(function(b){y(a,b)},function(b){B(a,b)})}catch(c){B(a,c)}}function I(){return ka++}function J(a){a[ea]=ka++,a._state=void 0,a._result=void 0,a._subscribers=[]}function K(a,b){this._instanceConstructor=a,this.promise=new a(q),this.promise[ea]||J(this.promise),U(b)?(this._input=b,this.length=b.length,this._remaining=b.length,this._result=new Array(this.length),0===this.length?A(this.promise,this._result):(this.length=this.length||0,this._enumerate(),0===this._remaining&&A(this.promise,this._result))):B(this.promise,L())}function L(){return new Error("Array Methods must be provided an Array")}function M(a){return new K(this,a).promise}function N(a){var b=this;return new b(U(a)?function(c,d){for(var e=a.length,f=0;f<e;f++)b.resolve(a[f]).then(c,d)}:function(a,b){return b(new TypeError("You must pass an array to race."))})}function O(a){var b=this,c=new b(q);return B(c,a),c}function P(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}function Q(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}function R(a){this[ea]=I(),this._result=this._state=void 0,this._subscribers=[],q!==a&&("function"!=typeof a&&P(),this instanceof R?H(this,a):Q())}function S(){var a=void 0;if("undefined"!=typeof f)a=f;else if("undefined"!=typeof self)a=self;else try{a=Function("return this")()}catch(b){throw new Error("polyfill failed because global object is unavailable in this environment")}var c=a.Promise;if(c){var d=null;try{d=Object.prototype.toString.call(c.resolve())}catch(b){}if("[object Promise]"===d&&!c.cast)return}a.Promise=R}var T=void 0;T=Array.isArray?Array.isArray:function(a){return"[object Array]"===Object.prototype.toString.call(a)};var U=T,V=0,W=void 0,X=void 0,Y=function(a,b){ca[V]=a,ca[V+1]=b,V+=2,2===V&&(X?X(m):da())},Z="undefined"!=typeof window?window:void 0,$=Z||{},_=$.MutationObserver||$.WebKitMutationObserver,aa="undefined"==typeof self&&"undefined"!=typeof e&&"[object process]"==={}.toString.call(e),ba="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel,ca=new Array(1e3),da=void 0;da=aa?h():_?j():ba?k():void 0===Z&&"function"==typeof b?n():l();var ea=Math.random().toString(36).substring(16),fa=void 0,ga=1,ha=2,ia=new E,ja=new E,ka=0;return K.prototype._enumerate=function(){for(var a=this.length,b=this._input,c=0;this._state===fa&&c<a;c++)this._eachEntry(b[c],c)},K.prototype._eachEntry=function(a,b){var c=this._instanceConstructor,d=c.resolve;if(d===p){var e=t(a);if(e===o&&a._state!==fa)this._settledAt(a._state,b,a._result);else if("function"!=typeof e)this._remaining--,this._result[b]=a;else if(c===R){var f=new c(q);x(f,a,e),this._willSettleAt(f,b)}else this._willSettleAt(new c(function(b){return b(a)}),b)}else this._willSettleAt(d(a),b)},K.prototype._settledAt=function(a,b,c){var d=this.promise;d._state===fa&&(this._remaining--,a===ha?B(d,c):this._result[b]=c),0===this._remaining&&A(d,this._result)},K.prototype._willSettleAt=function(a,b){var c=this;C(a,void 0,function(a){return c._settledAt(ga,b,a)},function(a){return c._settledAt(ha,b,a)})},R.all=M,R.race=N,R.resolve=p,R.reject=O,R._setScheduler=d,R._setAsap=g,R._asap=Y,R.prototype={constructor:R,then:o,catch:function(a){return this.then(null,a)}},S(),R.polyfill=S,R.Promise=R,R})}).call(this,b("_process"),"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{_process:16}],14:[function(a,b,c){var d=/[\.\:]/,e=b.exports=function(a,b,c){function f(b){var d,e=[].slice.call(arguments,1),g=i(b),h=m[g]||[];return n.forEach(function(a){a({name:g,args:e})}),d=[].concat(h).map(function(a){return a.apply(c||this,e)}),f.parent&&(d=d.concat(f.parent.apply(c||this,[(a?a+".":"")+g].concat(e)))),d}function g(a){a?delete m[i(a)]:m={}}function h(a){function b(){n.splice(n.indexOf(a),1)}return n.push(a),b}function i(a){return(Array.isArray(a)?a:a.split(d)).join(".")}function j(a,b){var c=m[i(a)]||[],d=c?c.indexOf(b._actual||b):-1;d>=0&&c.splice(d,1)}function k(a,b){var c;return a=i(a),c=m[a],c?c.push(b):m[a]=[b],f}function l(a,b){function c(){var d=b.apply(this,arguments);return f.off(a,c),d}return b._actual=c,k(a,c)}var m={},n=[];return"function"==typeof a&&(b=a,a=""),a=i(a||""),f.clear=f.removeAllListeners=g,f.feed=h,f.on=f.addListener=k,f.once=l,f.off=f.removeListener=j,f.parent=b||a&&e(),f}},{}],15:[function(a,b,c){function d(a){this._comparator=a||d.DEFAULT_COMPARATOR,this._elements=[]}b.exports=d,d.DEFAULT_COMPARATOR=function(a,b){return"number"==typeof a&&"number"==typeof b?a-b:(a=a.toString(),b=b.toString(),a==b?0:a>b?1:-1)},d.prototype.isEmpty=function(){return 0===this.size()},d.prototype.peek=function(){if(this.isEmpty())throw new Error("PriorityQueue is empty");return this._elements[0]},d.prototype.deq=function(){var a=this.peek(),b=this._elements.pop(),c=this.size();if(0===c)return a;this._elements[0]=b;for(var d=0;d<c;){var e=d,f=2*d+1,g=2*d+2;if(f<c&&this._compare(f,e)>=0&&(e=f),g<c&&this._compare(g,e)>=0&&(e=g),e===d)break;this._swap(e,d),d=e}return a},d.prototype.enq=function(a){for(var b=this._elements.push(a),c=b-1;c>0;){var d=Math.floor((c-1)/2);if(this._compare(c,d)<=0)break;this._swap(d,c),c=d}return b},d.prototype.size=function(){return this._elements.length},d.prototype.forEach=function(a){return this._elements.forEach(a)},d.prototype._compare=function(a,b){return this._comparator(this._elements[a],this._elements[b])},d.prototype._swap=function(a,b){var c=this._elements[a];this._elements[a]=this._elements[b],this._elements[b]=c}},{}],16:[function(a,b,c){function d(){throw new Error("setTimeout has not been defined")}function e(){throw new Error("clearTimeout has not been defined")}function f(a){if(l===setTimeout)return setTimeout(a,0);if((l===d||!l)&&setTimeout)return l=setTimeout,setTimeout(a,0);try{return l(a,0)}catch(b){try{return l.call(null,a,0)}catch(b){return l.call(this,a,0)}}}function g(a){if(m===clearTimeout)return clearTimeout(a);if((m===e||!m)&&clearTimeout)return m=clearTimeout,clearTimeout(a);try{return m(a)}catch(b){try{return m.call(null,a)}catch(b){return m.call(this,a)}}}function h(){q&&o&&(q=!1,o.length?p=o.concat(p):r=-1,p.length&&i())}function i(){if(!q){var a=f(h);q=!0;for(var b=p.length;b;){for(o=p,p=[];++r<b;)o&&o[r].run();r=-1,b=p.length}o=null,q=!1,g(a)}}function j(a,b){this.fun=a,this.array=b}function k(){}var l,m,n=b.exports={};!function(){try{l="function"==typeof setTimeout?setTimeout:d}catch(a){l=d}try{m="function"==typeof clearTimeout?clearTimeout:e}catch(a){m=e}}();var o,p=[],q=!1,r=-1;n.nextTick=function(a){var b=new Array(arguments.length-1);if(arguments.length>1)for(var c=1;c<arguments.length;c++)b[c-1]=arguments[c];p.push(new j(a,b)),1!==p.length||q||f(i)},j.prototype.run=function(){this.fun.apply(null,this.array)},n.title="browser",n.browser=!0,n.env={},n.argv=[],n.version="",n.versions={},n.on=k,n.addListener=k,n.once=k,n.off=k,n.removeListener=k,n.removeAllListeners=k,n.emit=k,n.binding=function(a){throw new Error("process.binding is not supported")},n.cwd=function(){return"/"},n.chdir=function(a){throw new Error("process.chdir is not supported")},n.umask=function(){return 0}},{}],17:[function(a,b,c){b.exports=/^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$|^(?:(?:(?:(?:(?:(?:(?:[0-9a-fA-F]{1,4})):){6})(?:(?:(?:(?:(?:[0-9a-fA-F]{1,4})):(?:(?:[0-9a-fA-F]{1,4})))|(?:(?:(?:(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9]))\.){3}(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9])))))))|(?:(?:::(?:(?:(?:[0-9a-fA-F]{1,4})):){5})(?:(?:(?:(?:(?:[0-9a-fA-F]{1,4})):(?:(?:[0-9a-fA-F]{1,4})))|(?:(?:(?:(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9]))\.){3}(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9])))))))|(?:(?:(?:(?:(?:[0-9a-fA-F]{1,4})))?::(?:(?:(?:[0-9a-fA-F]{1,4})):){4})(?:(?:(?:(?:(?:[0-9a-fA-F]{1,4})):(?:(?:[0-9a-fA-F]{1,4})))|(?:(?:(?:(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9]))\.){3}(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9])))))))|(?:(?:(?:(?:(?:(?:[0-9a-fA-F]{1,4})):){0,1}(?:(?:[0-9a-fA-F]{1,4})))?::(?:(?:(?:[0-9a-fA-F]{1,4})):){3})(?:(?:(?:(?:(?:[0-9a-fA-F]{1,4})):(?:(?:[0-9a-fA-F]{1,4})))|(?:(?:(?:(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9]))\.){3}(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9])))))))|(?:(?:(?:(?:(?:(?:[0-9a-fA-F]{1,4})):){0,2}(?:(?:[0-9a-fA-F]{1,4})))?::(?:(?:(?:[0-9a-fA-F]{1,4})):){2})(?:(?:(?:(?:(?:[0-9a-fA-F]{1,4})):(?:(?:[0-9a-fA-F]{1,4})))|(?:(?:(?:(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9]))\.){3}(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9])))))))|(?:(?:(?:(?:(?:(?:[0-9a-fA-F]{1,4})):){0,3}(?:(?:[0-9a-fA-F]{1,4})))?::(?:(?:[0-9a-fA-F]{1,4})):)(?:(?:(?:(?:(?:[0-9a-fA-F]{1,4})):(?:(?:[0-9a-fA-F]{1,4})))|(?:(?:(?:(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9]))\.){3}(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9])))))))|(?:(?:(?:(?:(?:(?:[0-9a-fA-F]{1,4})):){0,4}(?:(?:[0-9a-fA-F]{1,4})))?::)(?:(?:(?:(?:(?:[0-9a-fA-F]{1,4})):(?:(?:[0-9a-fA-F]{1,4})))|(?:(?:(?:(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9]))\.){3}(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9])))))))|(?:(?:(?:(?:(?:(?:[0-9a-fA-F]{1,4})):){0,5}(?:(?:[0-9a-fA-F]{1,4})))?::)(?:(?:[0-9a-fA-F]{1,4})))|(?:(?:(?:(?:(?:(?:[0-9a-fA-F]{1,4})):){0,6}(?:(?:[0-9a-fA-F]{1,4})))?::))))$/},{}],18:[function(a,b,c){"use strict";var d=a("detect-browser"),e=b.exports=function(a,b){var c,d,f,g=(b||{}).attach,h=this||("undefined"!=typeof window?window:void 0),i=((b||{}).prefixes||["ms","o","moz","webkit"]).concat("");if(h)for(c=i.length;c--;)if(d=i[c],f=d+(d?a.charAt(0).toUpperCase()+a.slice(1):a),"undefined"!=typeof h[f])return e.browser=e.browser||d.toLowerCase(),g&&(h[a]=h[f]),h[f]};e.moz="undefined"!=typeof navigator&&!!navigator.mozGetUserMedia,e.browser=d.name,e.browserVersion=e.version=d.version},{"detect-browser":11}],19:[function(a,b,c){b.exports=function(a,b){var c=(a||{}).ice,d=(a||{}).iceServers;return"function"==typeof c?c(a,b):Array.isArray(c)?b(null,[].concat(c)):void b(null,[].concat(d||[]))}},{}],20:[function(a,b,c){function d(a){return a&&"function"==typeof a.supported&&a.supported(f)}function e(a){var b=g.filter(function(b){return"function"==typeof a[b]});return b.length===g.length}var f=a("./detect"),g=["init"];b.exports=function(a){return[].concat(a||[]).filter(d).filter(e)[0]}},{"./detect":18}],21:[function(a,b,c){"use strict";var d=a("whisk/nub"),e=a("whisk/pluck"),f=a("whisk/flatten"),g=/\r?\n/,h=/\r?\n$/,i=["a","c","b","k"],j=a("./parsers");b.exports=function(a){var b,c={},k=[],l=a.split(g).filter(Boolean).map(function(a){return a.split("=")}),m=(d(l.filter(function(a){return a[0]&&i.indexOf(a[0])<0}).map(e(0))),c.findLine=function(a,b){var c=k.filter(function(b){return b[0]===a})[b||0];return c&&c[1]});return l.forEach(function(a){var c=j[a[0]];c?b=c(k,a):b?b=b(a):k.push(a)}),c.addIceCandidate=function(a){var b=(a||{}).lineIndex||(a||{}).sdpMLineIndex,c="undefined"!=typeof b&&m("m",b),d=(a||{}).candidate;c&&d&&c.childlines.push(d.replace(h,"").split("="))},c.getMediaTypes=function(){function a(a){return a[1].def.split(/\s/)[0]}return k.filter(function(a){return"m"===a[0]&&a[1]&&a[1].def}).map(a)},c.getMediaIDs=function(){return k.filter(function(a){return"m"===a[0]&&a[1]&&a[1].childlines&&a[1].childlines.length>0}).map(function(a){for(var b=a[1].childlines,c=a[1].def.split(/\s/)[0],d=0;d<b.length;d++){var e=b[d][1].split(":");if(e.length>0&&"mid"===e[0]){c=e[1];break}}return c})},c.toString=function(){return k.map(function(a){return"function"==typeof a[1].toArray?a[1].toArray():[a]}).reduce(f).map(function(a){return a.join("=")}).join("\r\n")+"\r\n"},c}},{"./parsers":22,"whisk/flatten":33,"whisk/nub":35,"whisk/pluck":36}],22:[function(a,b,c){"use strict";c.m=function(a,b){function c(a){return d.childlines.push(a),c}var d={def:b[1],childlines:[],toArray:function(){return[["m",d.def]].concat(d.childlines)}};return a.push(["m",d]),c}},{}],23:[function(a,b,c){function d(a){var b=f.exec(a);return b&&b[0]}var e=[[/^(a\=candidate.*)$/,a("rtc-validator/candidate")]],f=/(\r?\n|\\r\\n)/;b.exports=function(a,b){var c=d(a),f=a.split(c),g=(b||{}).collector;return f=f.filter(function(a){var b=e.reduce(function(b,c,d){return"undefined"!=typeof b?b:c[0].exec(a)&&{line:a.replace(c[0],"$1"),fn:c[1]}},void 0),c=b?b.fn(b.line):[];return g&&c.forEach(function(a){g.push(a)}),0===c.length}),f.join(c)}},{"rtc-validator/candidate":31}],24:[function(a,b,c){function d(a,b){return a&&"function"==typeof a?a:b}var e=a("rtc-core/detect"),f=a("rtc-core/plugin"),g=a("priorityqueuejs"),h=a("es6-promise").Promise,i=a("whisk/pluck"),j=i("sdp","type"),k=a("rtc-validator/candidate"),l=a("rtc-sdpclean"),m=a("rtc-sdp"),n=100,o=1e3,p=["createOffer","setLocalDescription","createAnswer","setRemoteDescription","addIceCandidate"],q={setLocalDescription:"setlocaldesc",setRemoteDescription:"setremotedesc",createOffer:"offer",createAnswer:"answer"},r={data:"application"},s=["have-remote-offer","have-local-pranswer"];b.exports=function(b,c){function i(a,d){function e(){M("ice.remote.applied",h),d()}function f(a){M("ice.remote.invalid",h),d(a)}var g=a.args[0];if(c&&c.filterCandidate&&!c.filterCandidate(g))return M("ice.remote.filtered",h),d();var h=g&&g.candidate&&W(g);return h?void b.addIceCandidate(h,e,f):d()}function t(){var a=!L.isEmpty()&&L.peek(),c=a&&J(a);return Q=0,c?(a=L.deq(),void a.fn(a,function(b){var c=a.fail||R,d=a.pass,e=a.name;return b?(console.error(e+" task failed: ",b),c(b)):("function"==typeof d&&d.apply(a,[].slice.call(arguments,1)),a.immediate?(Q&&clearTimeout(Q),t()):void K())})):(a&&(A(a)||z(a))&&(M("task.expire",a),L.deq()),!L.isEmpty()&&F(b)&&K())}function u(a){var c=[],d=a&&l(a.sdp,{collector:c});return a&&d!==a.sdp&&(console.info("invalid lines removed from sdp: ",c),a.sdp=d),"function"==typeof S&&(a.sdp=S(a.sdp,b)),a}function v(){if((b.__mediaIDs||b.__mediaTypes)&&(b.__mediaIDs=void 0,b.__mediaTypes=void 0),s.indexOf(b.signalingState)>=0)return M.createAnswer()}function w(){M("sdp.local",j(this.args[0]))}function x(a,b,c){return function(){var d=[].slice.call(arguments);c&&"function"==typeof c.processArgs&&(d=d.map(c.processArgs));var e=N.indexOf(a);return new h(function(f,g){L.enq({args:d,name:a,fn:b,priority:e>=0?e:n,immediate:c.immediate,aborted:!1,start:Date.now(),checks:[F].concat((c||{}).checks||[]),pass:function(){c&&c.pass&&c.pass.apply(this,arguments),f()},fail:function(){c&&c.fail&&c.fail.apply(this,arguments),g()}}),K()})}}function y(a,c){function d(b){M.apply(M,["negotiate.error",a.name,b].concat(a.args)),c(b)}function e(){M.apply(M,[["negotiate",g,"ok"],a.name].concat(a.args)),c.apply(null,[null].concat([].slice.call(arguments)))}var f=b[a.name],g=q[a.name]||(a.name||"").toLowerCase(),h=[e,d],i="createOffer"===a.name;return f?(M.apply(M,["negotiate."+g].concat(a.args)),void f.apply(b,a.args.concat(h).concat(i?C():[]))):c(new Error('cannot call "'+a.name+'" on RTCPeerConnection'))}function z(a){return"number"==typeof a.ttl&&a.start+a.ttl<Date.now()}function A(a){return a&&a.aborted}function B(a){for(;a&&a.candidate&&a.candidate.candidate;)a=a.candidate;return a}function C(){var a={offertoreceivevideo:"OfferToReceiveVideo",offertoreceiveaudio:"OfferToReceiveAudio",icerestart:"IceRestart",voiceactivitydetection:"VoiceActivityDetection"},b={OfferToReceiveVideo:!0,OfferToReceiveAudio:!0};return e.moz&&(a={offertoreceivevideo:"offerToReceiveVideo",
offertoreceiveaudio:"offerToReceiveAudio",icerestart:"iceRestart",voiceactivitydetection:"voiceActivityDetection"},b={offerToReceiveVideo:!0,offerToReceiveAudio:!0}),Object.keys(c||{}).forEach(function(d){a[d.toLowerCase()]&&(b[a[d.toLowerCase()]]=c[d])}),e.moz?b:{mandatory:b}}function D(a,b){return a.__hasDesc||(a.__hasDesc=!!a.remoteDescription)}function E(a){return"have-local-offer"!==a.signalingState}function F(a){return"closed"!==a.signalingState}function G(a,b){var c=b.__valid||(b.__valid=0===k(b.args[0]).length);return c||(b.aborted=!0),c}function H(a,b){var c=b.args[0]&&b.args[0].sdpMid;if(c=r[c]||c,""===c)return!0;if(T||!a.__mediaTypes){var d=m(a.remoteDescription&&a.remoteDescription.sdp),e=d.getMediaTypes();e&&e.length>0&&(a.__mediaTypes=e);var f=d.getMediaIDs();f&&f.length>0&&(a.__mediaIDs=f)}var g=a.__mediaIDs&&a.__mediaIDs.indexOf(c)>=0||a.__mediaTypes&&a.__mediaTypes.indexOf(c)>=0;return g||(b.aborted=!0),g}function I(a,b){var c=[a,b],d=c.map(J),e=c.map(function(a,b){var c=d[b];return c?a.priority:o});return e[1]-e[0]}function J(a){return(a.checks||[]).reduce(function(c,d){return c&&d(b,a)},!0)}function K(){Q||(Q=setTimeout(t,O))}c=c||{};var L=new g(I),M=a("mbus")("",(c||{}).logger),N=(c||{}).priorities||p,O=(c||{}).interval||10,P=f((c||{}).plugins),Q=0,R=M.bind(M,"fail"),S=(c||{}).sdpfilter||(c||{}).sdpFilter,T="always"===c.sdpParseMode,U=(c||{}).RTCSessionDescription||e("RTCSessionDescription"),V=(c||{}).RTCIceCandidate||e("RTCIceCandidate"),W=d(P&&P.createIceCandidate,function(a){return new V(a)}),X=d(P&&P.createSessionDescription,function(a){return new U(a)});M._qid=Math.floor(1e5*Math.random());return M.addIceCandidate=x("addIceCandidate",i,{processArgs:B,checks:[D,G,H],ttl:5e3,immediate:!0}),M.setLocalDescription=x("setLocalDescription",y,{processArgs:u,pass:w}),M.setRemoteDescription=x("setRemoteDescription",y,{processArgs:X,pass:v}),M.createOffer=x("createOffer",y,{checks:[E],pass:M.setLocalDescription}),M.createAnswer=x("createAnswer",y,{pass:M.setLocalDescription}),M}},{"es6-promise":13,mbus:14,priorityqueuejs:15,"rtc-core/detect":18,"rtc-core/plugin":20,"rtc-sdp":21,"rtc-sdpclean":23,"rtc-validator/candidate":31,"whisk/pluck":36}],25:[function(a,b,c){"use strict";var d=a("cog/logger")("rtc/cleanup"),e=["closed"],f=["addstream","datachannel","icecandidate","negotiationneeded","removestream","signalingstatechange"],g=["iceconnectionstatechange"];b.exports=function(a){function b(b){b.forEach(function(b){a["on"+b]&&(a["on"+b]=null)})}if(a){var c=a.iceConnectionState,h=a.signalingState,i=e.indexOf(c)<0&&e.indexOf(h)<0;if(b(f),i){d("attempting connection close, current state: "+a.iceConnectionState);try{a.close()}catch(j){console.warn("Could not close connection",j)}}setTimeout(function(){b(g)},100)}}},{"cog/logger":9}],26:[function(a,b,c){"use strict";function d(b,c,d,j){function n(){return!X&&"stable"===b.signalingState}function o(){n()&&(K("["+d.id+"] Creating new offer for connection to "+c),X=!0,$=!0,Y=!1,W.createOffer().then(function(){$=!1}).catch(function(){$=!1}))}function p(){K("decoupling "+d.id+" from "+c),clearTimeout(G),clearTimeout(F),clearTimeout(I),clearTimeout(H),L.close(),g(b),d.removeListener("sdp",s),d.removeListener("candidate",q),d.removeListener("endofcandidates",r),d.removeListener("negotiate",A),d.removeListener("ready",t),d.removeListener("requestoffer",D),d.removeListener("message:sdp",s),d.removeListener("message:candidate",q),d.removeListener("message:endofcandidates",r),d.removeListener("message:negotiate",A),d.removeListener("message:ready",t),d.removeListener("message:requestoffer",D)}function q(a,b){b&&b.id===c&&W.addIceCandidate(a)}function r(){}function s(a,b){b&&b.id===c&&(M("sdp.remote",a),W.setRemoteDescription(a).then(function(){X&&"answer"===a.type&&(K("coupling complete, can now trigger any pending renegotiations"),V&&Y&&aa())}))}function t(a){!Q&&a&&a.id===c&&(K("["+d.id+"] "+c+" is ready for coupling"),Q=!0,R=a.data,_=R.browser!==d.attributes.browser,M("target.ready"))}function u(){K("captured pc close, iceConnectionState = "+b.iceConnectionState),p()}function v(){K("captured pc disconnect, monitoring connection status"),F=setTimeout(function(){K("manually closing connection after disconnect timeout"),L("failed"),g(b)},P),L.on("statechange",w),L("failing")}function w(){if(K("connection state changed to: "+b.iceConnectionState),!(m.indexOf(b.iceConnectionState)>=0))return C(),l.indexOf(b.iceConnectionState)>=0?L("closed"):void L.once("disconnect",v)}function x(a){var b=a.candidate&&k(a.candidate);a.candidate?(C(),M("ice.local",b),d.to(c).send("/candidate",b),O=!1):O||(O=!0,M("ice.gathercomplete"),d.to(c).send("/endofcandidates",{}))}function y(){if(!X||N)return X?void(X&&N&&!Y&&(K("renegotiation is required, but deferring until existing connection is established"),Y=!0)):aa()}function z(){if(I&&clearTimeout(I),"closed"!==b.signalingState)return n()?(K("["+d.id+"] "+c+" has requested the ability to create the offer"),X=!0,d.to(c).send("/requestoffer")):(K("["+d.id+"] negotiation request denied, not in a state to accept new offers [coupling = "+X+", "+b.signalingState+"]"),void(I=setTimeout(z,500)))}function A(a,b){if(K("["+d.id+"] "+b.id+" has requested a negotiation"),b&&b.id===c)return M("negotiate.request",b.id,a),a&&a.requestOfferer?z():void y()}function B(){N&&(M("negotiate.renegotiate"),Z=!0,y())}function C(){var a=!!F&&l.indexOf(b.iceConnectionState)===-1;L.off("statechange",w),K("reset disconnect timer, state: "+b.iceConnectionState),clearTimeout(F),F=void 0,a&&L("recovered")}function D(a){if(a&&a.id===c)return K("["+d.id+"] "+c+" has requested that the offer be sent ["+a.id+"]"),o()}function E(){clearTimeout(G),d.to(c).send("/ready"),Q||(G=setTimeout(E,S))}var F,G,H,I,J=(j||{}).debugLabel||"rtc",K=a("cog/logger")(J+"/couple"),L=h(b,c,d,(j||{}).logger),M=e("",L),N=(j||{}).reactive,O=!0,P=(j||{}).disconnectTimeout||1e4,Q=!1,R=void 0,S=(j||{}).readyInterval||100,T=(j||{}).failTimeout||3e4,U=(j||{}).allowReactiveInterop,V=d.isMaster(c),W=f(b,j),X=!1,Y=!1,Z=!1,$=!1,_=!1,aa=i(function(){return Q?V?o():(K("["+d.id+"] Requesting negotiation from "+c+" (requesting offerer? "+Z+")"),d.to(c).send("/negotiate",{requestOfferer:(U||!_)&&Z})):(K("["+d.id+"] "+c+" not yet ready for offer"),M.once("target.ready",aa))},100,{leading:!1});return N&&(b.onnegotiationneeded=B),b.onicecandidate=x,W.on("sdp.local",function(a){d.to(c).send("/sdp",a)}),d.on("sdp",s),d.on("candidate",q),d.on("endofcandidates",r),d.on("ready",t),d.on("message:sdp",s),d.on("message:candidate",q),d.on("message:endofcandidates",r),d.on("message:ready",t),V?(d.on("negotiate",A),d.on("message:negotiate",A)):(d.on("requestoffer",D),d.on("message:requestoffer",D)),L.once("closed",u),L.once("disconnected",v),L.createOffer=aa,E(),K("["+d.id+"] ready for coupling to "+c),H=setTimeout(function(){L("failed"),p()},T),L.once("connected",function(){clearTimeout(H)}),L.on("signalingchange",function(a,b){K("["+d.id+"] signaling state "+b+" to "+c)}),L.on("signaling:stable",function(){!$&&X&&(X=!1),Y&&aa()}),L.stop=p,L.abort=function(){H&&clearTimeout(H),p(),L("aborted")},L.destroy=function(){L.clear(),W.clear()},L}var e=a("mbus"),f=a("rtc-taskqueue"),g=a("./cleanup"),h=a("./monitor"),i=a("cog/throttle"),j=a("whisk/pluck"),k=j("candidate","sdpMid","sdpMLineIndex"),l=["closed","failed"],m=["checking"];b.exports=d},{"./cleanup":25,"./monitor":30,"cog/logger":9,"cog/throttle":10,mbus:14,"rtc-taskqueue":24,"whisk/pluck":36}],27:[function(a,b,c){"use strict";b.exports=a("rtc-core/detect")},{"rtc-core/detect":18}],28:[function(a,b,c){"use strict";var d=a("cog/logger")("generators"),e=a("./detect"),f=a("cog/defaults"),g={create:{dtls:function(a){e.moz||(a.optional=(a.optional||[]).concat({DtlsSrtpKeyAgreement:!0}))}}};c.config=function(a){var b=(a||{}).iceServerGenerator;return f({},a,{iceServers:"function"==typeof b?b():[]})},c.connectionConstraints=function(a,b){var c,e={},h=g.create;return Object.keys(a||{}).forEach(function(a){h[a]&&h[a](e)}),c=f({},b,e),d("generated connection constraints: ",c),c}},{"./detect":27,"cog/defaults":6,"cog/logger":9}],29:[function(a,b,c){"use strict";var d=a("./generators"),e=c.detect=a("./detect"),f=a("rtc-core/plugin");c.logger=a("cog/logger");var g=c.RTCPeerConnection=e("RTCPeerConnection");c.couple=a("./couple"),c.createConnection=function(a,b){var c=f((a||{}).plugins),e=(a||{}).RTCPeerConnection||g,h=d.config(a);return b=d.connectionConstraints(a,b),c&&"function"==typeof c.createConnection?c.createConnection(h,b):new e(h,b)}},{"./couple":26,"./detect":27,"./generators":28,"cog/logger":9,"rtc-core/plugin":20}],30:[function(a,b,c){"use strict";function d(a){return f[a]||a}var e=a("mbus"),f={completed:"connected"},g=["signalingstatechange","iceconnectionstatechange"];b.exports=function(a,b,c,f){function h(){var b=a.iceConnectionState,c=d(b),e=a.signalingState;m("statechange",a,c),m("connectionstatechange",a,b),j!==c&&(m(c),j=c),k!==b&&(m("connectionstate:"+b),k=b),"closed"!==c||n||i(),l!==e&&(m("signalingchange",a,e,l),m("signaling:"+e,a,e,l),l=e)}function i(){n=!0,m("closed")}var j,k,l,m=e("",f),n=!1;return a.onclose=i,g.forEach(function(b){a["on"+b]=h}),m.close=function(){a.onclose=null,g.forEach(function(b){a["on"+b]=null})},m.checkState=h,m.destroy=function(){m.clear()},a?(j=d(a.iceConnectionState),m):m}},{mbus:14}],31:[function(a,b,c){function d(a,b){var c=g[b];if(c&&!c[0].test(a))return e(c[2]+" part failed validation: "+a),new Error(c[1])}var e=a("cog/logger")("rtc-validator"),f=/^(?:a=)?candidate:/,g=[[/.+/,"invalid foundation component","foundation"],[/\d+/,"invalid component id","component-id"],[/(UDP|TCP)/i,"transport must be TCP or UDP","transport"],[/\d+/,"numeric priority expected","priority"],[a("reu/ip"),"invalid connection address","connection-address"],[/\d+/,"invalid connection port","connection-port"],[/typ/,'Expected "typ" identifier',"type classifier"],[/.+/,"Invalid candidate type specified","candidate-type"]];b.exports=function(a){var b=[],c=a&&(a.candidate||a),e=c&&f.exec(c),g=e&&c.slice(e[0].length).split(/\s/);return c?e?b=b.concat(g.map(d)).filter(Boolean):[new Error("candidate did not match expected sdp line format")]:[new Error("empty candidate")]}},{"cog/logger":9,"reu/ip":17}],32:[function(a,b,c){b.exports=function(a,b){return arguments.length>1?a===b:function(b){return a===b}}},{}],33:[function(a,b,c){b.exports=function(a,b){return a=Array.isArray(a)?a:[a],a.concat(b)}},{}],34:[function(a,b,c){b.exports=function(a){return function(b){for(var c=[],d=0,e=b.length;d<e;d++){for(var f=!1,g=c.length;g--;)f=f||a(b[d],c[g]);f||(c[c.length]=b[d])}return c}}},{}],35:[function(a,b,c){b.exports=a("./nub-by")(a("./equality"))},{"./equality":32,"./nub-by":34}],36:[function(a,b,c){b.exports=function(){function a(a,b){return function(c){var d=0,e=c;do e=e&&e[a[d++]];while(e&&d<=b);return e}}var b=[];return[].slice.call(arguments).forEach(function(a){var c="number"==typeof a?[a]:(a||"").split(".");b[b.length]={name:c[0],parts:c,maxIdx:c.length-1}}),b.length<=1?a(b[0].parts,b[0].maxIdx):function(c){for(var d={},e=0,f=b.length;e<f;e++)d[b[e].name]=a([b[e].parts[0]],0)(c);return d}}},{}]},{},[1])(1)});